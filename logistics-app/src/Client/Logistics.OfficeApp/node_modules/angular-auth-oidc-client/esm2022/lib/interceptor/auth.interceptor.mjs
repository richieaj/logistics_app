import { Injectable, inject } from '@angular/core';
import { AuthStateService } from '../auth-state/auth-state.service';
import { ConfigurationService } from '../config/config.service';
import { LoggerService } from '../logging/logger.service';
import { flattenArray } from '../utils/collections/collections.helper';
import { ClosestMatchingRouteService } from './closest-matching-route.service';
import * as i0 from "@angular/core";
export class AuthInterceptor {
    constructor() {
        this.authStateService = inject(AuthStateService);
        this.configurationService = inject(ConfigurationService);
        this.loggerService = inject(LoggerService);
        this.closestMatchingRouteService = inject(ClosestMatchingRouteService);
    }
    intercept(req, next) {
        return interceptRequest(req, next.handle, {
            configurationService: this.configurationService,
            authStateService: this.authStateService,
            closestMatchingRouteService: this.closestMatchingRouteService,
            loggerService: this.loggerService,
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: AuthInterceptor, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: AuthInterceptor }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: AuthInterceptor, decorators: [{
            type: Injectable
        }] });
export function authInterceptor() {
    return (req, next) => {
        return interceptRequest(req, next, {
            configurationService: inject(ConfigurationService),
            authStateService: inject(AuthStateService),
            closestMatchingRouteService: inject(ClosestMatchingRouteService),
            loggerService: inject(LoggerService),
        });
    };
}
function interceptRequest(req, next, deps) {
    if (!deps.configurationService.hasAtLeastOneConfig()) {
        return next(req);
    }
    const allConfigurations = deps.configurationService.getAllConfigurations();
    const allRoutesConfigured = allConfigurations.map((x) => x.secureRoutes || []);
    const allRoutesConfiguredFlat = flattenArray(allRoutesConfigured);
    if (allRoutesConfiguredFlat.length === 0) {
        deps.loggerService.logDebug(allConfigurations[0], `No routes to check configured`);
        return next(req);
    }
    const { matchingConfig, matchingRoute } = deps.closestMatchingRouteService.getConfigIdForClosestMatchingRoute(req.url, allConfigurations);
    if (!matchingConfig) {
        deps.loggerService.logDebug(allConfigurations[0], `Did not find any configured route for route ${req.url}`);
        return next(req);
    }
    deps.loggerService.logDebug(matchingConfig, `'${req.url}' matches configured route '${matchingRoute}'`);
    const token = deps.authStateService.getAccessToken(matchingConfig);
    if (!token) {
        deps.loggerService.logDebug(matchingConfig, `Wanted to add token to ${req.url} but found no token: '${token}'`);
        return next(req);
    }
    deps.loggerService.logDebug(matchingConfig, `'${req.url}' matches configured route '${matchingRoute}', adding token`);
    req = req.clone({
        headers: req.headers.set('Authorization', 'Bearer ' + token),
    });
    return next(req);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItYXV0aC1vaWRjLWNsaWVudC9zcmMvbGliL2ludGVyY2VwdG9yL2F1dGguaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7QUFHL0UsTUFBTSxPQUFPLGVBQWU7SUFENUI7UUFFbUIscUJBQWdCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFNUMseUJBQW9CLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFFcEQsa0JBQWEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFdEMsZ0NBQTJCLEdBQUcsTUFBTSxDQUNuRCwyQkFBMkIsQ0FDNUIsQ0FBQztLQWFIO0lBWEMsU0FBUyxDQUNQLEdBQXFCLEVBQ3JCLElBQWlCO1FBRWpCLE9BQU8sZ0JBQWdCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDeEMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLG9CQUFvQjtZQUMvQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0JBQWdCO1lBQ3ZDLDJCQUEyQixFQUFFLElBQUksQ0FBQywyQkFBMkI7WUFDN0QsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQ2xDLENBQUMs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O0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwSGFuZGxlckZuLCBIdHRwSW50ZXJjZXB0b3IsIEh0dHBJbnRlcmNlcHRvckZuLCBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXV0aFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2F1dGgtc3RhdGUvYXV0aC1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vY29uZmlnL2NvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2UgfSBmcm9tICcuLi9sb2dnaW5nL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IGZsYXR0ZW5BcnJheSB9IGZyb20gJy4uL3V0aWxzL2NvbGxlY3Rpb25zL2NvbGxlY3Rpb25zLmhlbHBlcic7XG5pbXBvcnQgeyBDbG9zZXN0TWF0Y2hpbmdSb3V0ZVNlcnZpY2UgfSBmcm9tICcuL2Nsb3Nlc3QtbWF0Y2hpbmctcm91dGUuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuICBwcml2YXRlIHJlYWRvbmx5IGF1dGhTdGF0ZVNlcnZpY2UgPSBpbmplY3QoQXV0aFN0YXRlU2VydmljZSk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWd1cmF0aW9uU2VydmljZSA9IGluamVjdChDb25maWd1cmF0aW9uU2VydmljZSk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXJTZXJ2aWNlID0gaW5qZWN0KExvZ2dlclNlcnZpY2UpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY2xvc2VzdE1hdGNoaW5nUm91dGVTZXJ2aWNlID0gaW5qZWN0KFxuICAgIENsb3Nlc3RNYXRjaGluZ1JvdXRlU2VydmljZVxuICApO1xuXG4gIGludGVyY2VwdChcbiAgICByZXE6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgbmV4dDogSHR0cEhhbmRsZXJcbiAgKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIHJldHVybiBpbnRlcmNlcHRSZXF1ZXN0KHJlcSwgbmV4dC5oYW5kbGUsIHtcbiAgICAgIGNvbmZpZ3VyYXRpb25TZXJ2aWNlOiB0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLFxuICAgICAgYXV0aFN0YXRlU2VydmljZTogdGhpcy5hdXRoU3RhdGVTZXJ2aWNlLFxuICAgICAgY2xvc2VzdE1hdGNoaW5nUm91dGVTZXJ2aWNlOiB0aGlzLmNsb3Nlc3RNYXRjaGluZ1JvdXRlU2VydmljZSxcbiAgICAgIGxvZ2dlclNlcnZpY2U6IHRoaXMubG9nZ2VyU2VydmljZSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXV0aEludGVyY2VwdG9yKCk6IEh0dHBJbnRlcmNlcHRvckZuIHtcbiAgcmV0dXJuIChyZXEsIG5leHQpID0+IHtcbiAgICByZXR1cm4gaW50ZXJjZXB0UmVxdWVzdChyZXEsIG5leHQsIHtcbiAgICAgIGNvbmZpZ3VyYXRpb25TZXJ2aWNlOiBpbmplY3QoQ29uZmlndXJhdGlvblNlcnZpY2UpLFxuICAgICAgYXV0aFN0YXRlU2VydmljZTogaW5qZWN0KEF1dGhTdGF0ZVNlcnZpY2UpLFxuICAgICAgY2xvc2VzdE1hdGNoaW5nUm91dGVTZXJ2aWNlOiBpbmplY3QoQ2xvc2VzdE1hdGNoaW5nUm91dGVTZXJ2aWNlKSxcbiAgICAgIGxvZ2dlclNlcnZpY2U6IGluamVjdChMb2dnZXJTZXJ2aWNlKSxcbiAgICB9KTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gaW50ZXJjZXB0UmVxdWVzdChcbiAgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LFxuICBuZXh0OiBIdHRwSGFuZGxlckZuLFxuICBkZXBzOiB7XG4gICAgYXV0aFN0YXRlU2VydmljZTogQXV0aFN0YXRlU2VydmljZTtcbiAgICBjb25maWd1cmF0aW9uU2VydmljZTogQ29uZmlndXJhdGlvblNlcnZpY2U7XG4gICAgbG9nZ2VyU2VydmljZTogTG9nZ2VyU2VydmljZTtcbiAgICBjbG9zZXN0TWF0Y2hpbmdSb3V0ZVNlcnZpY2U6IENsb3Nlc3RNYXRjaGluZ1JvdXRlU2VydmljZTtcbiAgfVxuKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8dW5rbm93bj4+IHtcbiAgaWYgKCFkZXBzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0F0TGVhc3RPbmVDb25maWcoKSkge1xuICAgIHJldHVybiBuZXh0KHJlcSk7XG4gIH1cblxuICBjb25zdCBhbGxDb25maWd1cmF0aW9ucyA9IGRlcHMuY29uZmlndXJhdGlvblNlcnZpY2UuZ2V0QWxsQ29uZmlndXJhdGlvbnMoKTtcbiAgY29uc3QgYWxsUm91dGVzQ29uZmlndXJlZCA9IGFsbENvbmZpZ3VyYXRpb25zLm1hcChcbiAgICAoeCkgPT4geC5zZWN1cmVSb3V0ZXMgfHwgW11cbiAgKTtcbiAgY29uc3QgYWxsUm91dGVzQ29uZmlndXJlZEZsYXQgPSBmbGF0dGVuQXJyYXkoYWxsUm91dGVzQ29uZmlndXJlZCk7XG5cbiAgaWYgKGFsbFJvdXRlc0NvbmZpZ3VyZWRGbGF0Lmxlbmd0aCA9PT0gMCkge1xuICAgIGRlcHMubG9nZ2VyU2VydmljZS5sb2dEZWJ1ZyhcbiAgICAgIGFsbENvbmZpZ3VyYXRpb25zWzBdLFxuICAgICAgYE5vIHJvdXRlcyB0byBjaGVjayBjb25maWd1cmVkYFxuICAgICk7XG5cbiAgICByZXR1cm4gbmV4dChyZXEpO1xuICB9XG5cbiAgY29uc3QgeyBtYXRjaGluZ0NvbmZpZywgbWF0Y2hpbmdSb3V0ZSB9ID1cbiAgICBkZXBzLmNsb3Nlc3RNYXRjaGluZ1JvdXRlU2VydmljZS5nZXRDb25maWdJZEZvckNsb3Nlc3RNYXRjaGluZ1JvdXRlKFxuICAgICAgcmVxLnVybCxcbiAgICAgIGFsbENvbmZpZ3VyYXRpb25zXG4gICAgKTtcblxuICBpZiAoIW1hdGNoaW5nQ29uZmlnKSB7XG4gICAgZGVwcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgICAgYWxsQ29uZmlndXJhdGlvbnNbMF0sXG4gICAgICBgRGlkIG5vdCBmaW5kIGFueSBjb25maWd1cmVkIHJvdXRlIGZvciByb3V0ZSAke3JlcS51cmx9YFxuICAgICk7XG5cbiAgICByZXR1cm4gbmV4dChyZXEpO1xuICB9XG5cbiAgZGVwcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgIG1hdGNoaW5nQ29uZmlnLFxuICAgIGAnJHtyZXEudXJsfScgbWF0Y2hlcyBjb25maWd1cmVkIHJvdXRlICcke21hdGNoaW5nUm91dGV9J2BcbiAgKTtcbiAgY29uc3QgdG9rZW4gPSBkZXBzLmF1dGhTdGF0ZVNlcnZpY2UuZ2V0QWNjZXNzVG9rZW4obWF0Y2hpbmdDb25maWcpO1xuXG4gIGlmICghdG9rZW4pIHtcbiAgICBkZXBzLmxvZ2dlclNlcnZpY2UubG9nRGVidWcoXG4gICAgICBtYXRjaGluZ0NvbmZpZyxcbiAgICAgIGBXYW50ZWQgdG8gYWRkIHRva2VuIHRvICR7cmVxLnVybH0gYnV0IGZvdW5kIG5vIHRva2VuOiAnJHt0b2tlbn0nYFxuICAgICk7XG5cbiAgICByZXR1cm4gbmV4dChyZXEpO1xuICB9XG5cbiAgZGVwcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgIG1hdGNoaW5nQ29uZmlnLFxuICAgIGAnJHtyZXEudXJsfScgbWF0Y2hlcyBjb25maWd1cmVkIHJvdXRlICcke21hdGNoaW5nUm91dGV9JywgYWRkaW5nIHRva2VuYFxuICApO1xuICByZXEgPSByZXEuY2xvbmUoe1xuICAgIGhlYWRlcnM6IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCZWFyZXIgJyArIHRva2VuKSxcbiAgfSk7XG5cbiAgcmV0dXJuIG5leHQocmVxKTtcbn1cbiJdfQ==