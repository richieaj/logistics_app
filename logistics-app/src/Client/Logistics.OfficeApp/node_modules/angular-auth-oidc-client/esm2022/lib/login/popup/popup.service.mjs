import { DOCUMENT } from '@angular/common';
import { Injectable, inject } from '@angular/core';
import { Subject } from 'rxjs';
import { LoggerService } from '../../logging/logger.service';
import { StoragePersistenceService } from '../../storage/storage-persistence.service';
import * as i0 from "@angular/core";
export class PopUpService {
    constructor() {
        this.loggerService = inject(LoggerService);
        this.storagePersistenceService = inject(StoragePersistenceService);
        this.document = inject(DOCUMENT);
        this.STORAGE_IDENTIFIER = 'popupauth';
        this.popUp = null;
        this.handle = -1;
        this.resultInternal$ = new Subject();
    }
    get result$() {
        return this.resultInternal$.asObservable();
    }
    get windowInternal() {
        return this.document.defaultView;
    }
    isCurrentlyInPopup(config) {
        if (this.canAccessSessionStorage()) {
            const popup = this.storagePersistenceService.read(this.STORAGE_IDENTIFIER, config);
            const windowIdentifier = this.windowInternal;
            if (!windowIdentifier) {
                return false;
            }
            return (Boolean(windowIdentifier.opener) &&
                windowIdentifier.opener !== windowIdentifier &&
                Boolean(popup));
        }
        return false;
    }
    openPopUp(url, popupOptions, config) {
        const optionsToPass = this.getOptions(popupOptions);
        this.storagePersistenceService.write(this.STORAGE_IDENTIFIER, 'true', config);
        const windowIdentifier = this.windowInternal;
        if (!windowIdentifier) {
            return;
        }
        if (!url) {
            this.loggerService.logError(config, 'Could not open popup, url is empty');
            return;
        }
        this.popUp = windowIdentifier.open(url, '_blank', optionsToPass);
        if (!this.popUp) {
            this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER, config);
            this.loggerService.logError(config, 'Could not open popup');
            return;
        }
        this.loggerService.logDebug(config, 'Opened popup with url ' + url);
        const listener = (event) => {
            if (!event?.data || typeof event.data !== 'string') {
                this.cleanUp(listener, config);
                return;
            }
            this.loggerService.logDebug(config, 'Received message from popup with url ' + event.data);
            this.resultInternal$.next({ userClosed: false, receivedUrl: event.data });
            this.cleanUp(listener, config);
        };
        windowIdentifier.addEventListener('message', listener, false);
        this.handle = windowIdentifier.setInterval(() => {
            if (this.popUp?.closed) {
                this.resultInternal$.next({ userClosed: true, receivedUrl: '' });
                this.cleanUp(listener, config);
            }
        }, 200);
    }
    sendMessageToMainWindow(url, config) {
        const windowIdentifier = this.windowInternal;
        if (!windowIdentifier) {
            return;
        }
        if (windowIdentifier.opener) {
            const href = windowIdentifier.location.href;
            this.sendMessage(url, href, config);
        }
    }
    cleanUp(listener, config) {
        const windowIdentifier = this.windowInternal;
        if (!windowIdentifier) {
            return;
        }
        windowIdentifier.removeEventListener('message', listener, false);
        windowIdentifier.clearInterval(this.handle);
        if (this.popUp) {
            this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER, config);
            this.popUp.close();
            this.popUp = null;
        }
    }
    sendMessage(url, href, config) {
        const windowIdentifier = this.windowInternal;
        if (!windowIdentifier) {
            return;
        }
        if (!url) {
            this.loggerService.logDebug(config, `Can not send message to parent, no url: '${url}'`);
            return;
        }
        windowIdentifier.opener.postMessage(url, href);
    }
    getOptions(popupOptions) {
        const popupDefaultOptions = {
            width: 500,
            height: 500,
            left: 50,
            top: 50,
        };
        const options = {
            ...popupDefaultOptions,
            ...(popupOptions || {}),
        };
        const windowIdentifier = this.windowInternal;
        if (!windowIdentifier) {
            return '';
        }
        const width = options.width || popupDefaultOptions.width;
        const height = options.height || popupDefaultOptions.height;
        const left = windowIdentifier.screenLeft + (windowIdentifier.outerWidth - width) / 2;
        const top = windowIdentifier.screenTop + (windowIdentifier.outerHeight - height) / 2;
        options.left = left;
        options.top = top;
        return Object.entries(options)
            .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
            .join(',');
    }
    canAccessSessionStorage() {
        return (typeof navigator !== 'undefined' &&
            navigator.cookieEnabled &&
            typeof Storage !== 'undefined');
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: PopUpService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: PopUpService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: PopUpService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItYXV0aC1vaWRjLWNsaWVudC9zcmMvbGliL2xvZ2luL3BvcHVwL3BvcHVwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzdELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDOztBQUt0RixNQUFNLE9BQU8sWUFBWTtJQUR6QjtRQUVtQixrQkFBYSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUV0Qyw4QkFBeUIsR0FBRyxNQUFNLENBQ2pELHlCQUF5QixDQUMxQixDQUFDO1FBRWUsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU1Qix1QkFBa0IsR0FBRyxXQUFXLENBQUM7UUFFMUMsVUFBSyxHQUFrQixJQUFJLENBQUM7UUFFNUIsV0FBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRUgsb0JBQWUsR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO0tBa00vRDtJQWhNQyxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQVksY0FBYztRQUN4QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO0lBQ25DLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxNQUEyQjtRQUM1QyxJQUFJLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLENBQUM7WUFDbkMs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Z0IsQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTNFLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBRWxCLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7YUFDM0IsR0FBRyxDQUNGLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUNmLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLElBQUksa0JBQWtCLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDNUQ7YUFDQSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDZixDQUFDO0lBRU8sdUJBQXVCO1FBQzdCLE9BQU8sQ0FDTCxPQUFPLFNBQVMsS0FBSyxXQUFXO1lBQ2hDLFNBQVMsQ0FBQyxhQUFhO1lBQ3ZCLE9BQU8sT0FBTyxLQUFLLFdBQVcsQ0FDL0IsQ0FBQztJQUNKLENBQUM7OEdBaE5VLFlBQVk7a0hBQVosWUFBWSxjQURDLE1BQU07OzJGQUNuQixZQUFZO2tCQUR4QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgT3BlbklkQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uLy4uL2NvbmZpZy9vcGVuaWQtY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBTdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3RvcmFnZS9zdG9yYWdlLXBlcnNpc3RlbmNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9wdXBPcHRpb25zIH0gZnJvbSAnLi9wb3B1cC1vcHRpb25zJztcbmltcG9ydCB7IFBvcHVwUmVzdWx0IH0gZnJvbSAnLi9wb3B1cC1yZXN1bHQnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFBvcFVwU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyU2VydmljZSA9IGluamVjdChMb2dnZXJTZXJ2aWNlKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UgPSBpbmplY3QoXG4gICAgU3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZVxuICApO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQgPSBpbmplY3QoRE9DVU1FTlQpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgU1RPUkFHRV9JREVOVElGSUVSID0gJ3BvcHVwYXV0aCc7XG5cbiAgcHJpdmF0ZSBwb3BVcDogV2luZG93IHwgbnVsbCA9IG51bGw7XG5cbiAgcHJpdmF0ZSBoYW5kbGUgPSAtMTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHJlc3VsdEludGVybmFsJCA9IG5ldyBTdWJqZWN0PFBvcHVwUmVzdWx0PigpO1xuXG4gIGdldCByZXN1bHQkKCk6IE9ic2VydmFibGU8UG9wdXBSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5yZXN1bHRJbnRlcm5hbCQuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIGdldCB3aW5kb3dJbnRlcm5hbCgpOiBXaW5kb3cgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5kZWZhdWx0VmlldztcbiAgfVxuXG4gIGlzQ3VycmVudGx5SW5Qb3B1cChjb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5jYW5BY2Nlc3NTZXNzaW9uU3RvcmFnZSgpKSB7XG4gICAgICBjb25zdCBwb3B1cCA9IHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5yZWFkKFxuICAgICAgICB0aGlzLlNUT1JBR0VfSURFTlRJRklFUixcbiAgICAgICAgY29uZmlnXG4gICAgICApO1xuXG4gICAgICBjb25zdCB3aW5kb3dJZGVudGlmaWVyID0gdGhpcy53aW5kb3dJbnRlcm5hbDtcblxuICAgICAgaWYgKCF3aW5kb3dJZGVudGlmaWVyKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgQm9vbGVhbih3aW5kb3dJZGVudGlmaWVyLm9wZW5lcikgJiZcbiAgICAgICAgd2luZG93SWRlbnRpZmllci5vcGVuZXIgIT09IHdpbmRvd0lkZW50aWZpZXIgJiZcbiAgICAgICAgQm9vbGVhbihwb3B1cClcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgb3BlblBvcFVwKFxuICAgIHVybDogc3RyaW5nIHwgbnVsbCxcbiAgICBwb3B1cE9wdGlvbnM6IFBvcHVwT3B0aW9ucyB8IHVuZGVmaW5lZCxcbiAgICBjb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb25cbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgb3B0aW9uc1RvUGFzcyA9IHRoaXMuZ2V0T3B0aW9ucyhwb3B1cE9wdGlvbnMpO1xuXG4gICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLndyaXRlKFxuICAgICAgdGhpcy5TVE9SQUdFX0lERU5USUZJRVIsXG4gICAgICAndHJ1ZScsXG4gICAgICBjb25maWdcbiAgICApO1xuXG4gICAgY29uc3Qgd2luZG93SWRlbnRpZmllciA9IHRoaXMud2luZG93SW50ZXJuYWw7XG5cbiAgICBpZiAoIXdpbmRvd0lkZW50aWZpZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXVybCkge1xuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKGNvbmZpZywgJ0NvdWxkIG5vdCBvcGVuIHBvcHVwLCB1cmwgaXMgZW1wdHknKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucG9wVXAgPSB3aW5kb3dJZGVudGlmaWVyLm9wZW4odXJsLCAnX2JsYW5rJywgb3B0aW9uc1RvUGFzcyk7XG5cbiAgICBpZiAoIXRoaXMucG9wVXApIHtcbiAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5yZW1vdmUodGhpcy5TVE9SQUdFX0lERU5USUZJRVIsIGNvbmZpZyk7XG4gICAgICB0aGlzLmxvZ2dlclNlcnZpY2UubG9nRXJyb3IoY29uZmlnLCAnQ291bGQgbm90IG9wZW4gcG9wdXAnKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dEZWJ1Zyhjb25maWcsICdPcGVuZWQgcG9wdXAgd2l0aCB1cmwgJyArIHVybCk7XG5cbiAgICBjb25zdCBsaXN0ZW5lciA9IChldmVudDogTWVzc2FnZUV2ZW50KTogdm9pZCA9PiB7XG4gICAgICBpZiAoIWV2ZW50Py5kYXRhIHx8IHR5cGVvZiBldmVudC5kYXRhICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aGlzLmNsZWFuVXAobGlzdGVuZXIsIGNvbmZpZyk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlclNlcnZpY2UubG9nRGVidWcoXG4gICAgICAgIGNvbmZpZyxcbiAgICAgICAgJ1JlY2VpdmVkIG1lc3NhZ2UgZnJvbSBwb3B1cCB3aXRoIHVybCAnICsgZXZlbnQuZGF0YVxuICAgICAgKTtcblxuICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IGZhbHNlLCByZWNlaXZlZFVybDogZXZlbnQuZGF0YSB9KTtcblxuICAgICAgdGhpcy5jbGVhblVwKGxpc3RlbmVyLCBjb25maWcpO1xuICAgIH07XG5cbiAgICB3aW5kb3dJZGVudGlmaWVyLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBsaXN0ZW5lciwgZmFsc2UpO1xuXG4gICAgdGhpcy5oYW5kbGUgPSB3aW5kb3dJZGVudGlmaWVyLnNldEludGVydmFsKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLnBvcFVwPy5jbG9zZWQpIHtcbiAgICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IHRydWUsIHJlY2VpdmVkVXJsOiAnJyB9KTtcblxuICAgICAgICB0aGlzLmNsZWFuVXAobGlzdGVuZXIsIGNvbmZpZyk7XG4gICAgICB9XG4gICAgfSwgMjAwKTtcbiAgfVxuXG4gIHNlbmRNZXNzYWdlVG9NYWluV2luZG93KHVybDogc3RyaW5nLCBjb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiB2b2lkIHtcbiAgICBjb25zdCB3aW5kb3dJZGVudGlmaWVyID0gdGhpcy53aW5kb3dJbnRlcm5hbDtcblxuICAgIGlmICghd2luZG93SWRlbnRpZmllcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh3aW5kb3dJZGVudGlmaWVyLm9wZW5lcikge1xuICAgICAgY29uc3QgaHJlZiA9IHdpbmRvd0lkZW50aWZpZXIubG9jYXRpb24uaHJlZjtcblxuICAgICAgdGhpcy5zZW5kTWVzc2FnZSh1cmwsIGhyZWYsIGNvbmZpZyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbGVhblVwKGxpc3RlbmVyOiBhbnksIGNvbmZpZzogT3BlbklkQ29uZmlndXJhdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHdpbmRvd0lkZW50aWZpZXIgPSB0aGlzLndpbmRvd0ludGVybmFsO1xuXG4gICAgaWYgKCF3aW5kb3dJZGVudGlmaWVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgd2luZG93SWRlbnRpZmllci5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgbGlzdGVuZXIsIGZhbHNlKTtcbiAgICB3aW5kb3dJZGVudGlmaWVyLmNsZWFySW50ZXJ2YWwodGhpcy5oYW5kbGUpO1xuXG4gICAgaWYgKHRoaXMucG9wVXApIHtcbiAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5yZW1vdmUodGhpcy5TVE9SQUdFX0lERU5USUZJRVIsIGNvbmZpZyk7XG4gICAgICB0aGlzLnBvcFVwLmNsb3NlKCk7XG4gICAgICB0aGlzLnBvcFVwID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbmRNZXNzYWdlKFxuICAgIHVybDogc3RyaW5nLFxuICAgIGhyZWY6IHN0cmluZyxcbiAgICBjb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb25cbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgd2luZG93SWRlbnRpZmllciA9IHRoaXMud2luZG93SW50ZXJuYWw7XG5cbiAgICBpZiAoIXdpbmRvd0lkZW50aWZpZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXVybCkge1xuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKFxuICAgICAgICBjb25maWcsXG4gICAgICAgIGBDYW4gbm90IHNlbmQgbWVzc2FnZSB0byBwYXJlbnQsIG5vIHVybDogJyR7dXJsfSdgXG4gICAgICApO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgd2luZG93SWRlbnRpZmllci5vcGVuZXIucG9zdE1lc3NhZ2UodXJsLCBocmVmKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3B0aW9ucyhwb3B1cE9wdGlvbnM6IFBvcHVwT3B0aW9ucyB8IHVuZGVmaW5lZCk6IHN0cmluZyB7XG4gICAgY29uc3QgcG9wdXBEZWZhdWx0T3B0aW9ucyA9IHtcbiAgICAgIHdpZHRoOiA1MDAsXG4gICAgICBoZWlnaHQ6IDUwMCxcbiAgICAgIGxlZnQ6IDUwLFxuICAgICAgdG9wOiA1MCxcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnM6IFBvcHVwT3B0aW9ucyA9IHtcbiAgICAgIC4uLnBvcHVwRGVmYXVsdE9wdGlvbnMsXG4gICAgICAuLi4ocG9wdXBPcHRpb25zIHx8IHt9KSxcbiAgICB9O1xuICAgIGNvbnN0IHdpbmRvd0lkZW50aWZpZXIgPSB0aGlzLndpbmRvd0ludGVybmFsO1xuXG4gICAgaWYgKCF3aW5kb3dJZGVudGlmaWVyKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgY29uc3Qgd2lkdGggPSBvcHRpb25zLndpZHRoIHx8IHBvcHVwRGVmYXVsdE9wdGlvbnMud2lkdGg7XG4gICAgY29uc3QgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgcG9wdXBEZWZhdWx0T3B0aW9ucy5oZWlnaHQ7XG5cbiAgICBjb25zdCBsZWZ0OiBudW1iZXIgPVxuICAgICAgd2luZG93SWRlbnRpZmllci5zY3JlZW5MZWZ0ICsgKHdpbmRvd0lkZW50aWZpZXIub3V0ZXJXaWR0aCAtIHdpZHRoKSAvIDI7XG4gICAgY29uc3QgdG9wOiBudW1iZXIgPVxuICAgICAgd2luZG93SWRlbnRpZmllci5zY3JlZW5Ub3AgKyAod2luZG93SWRlbnRpZmllci5vdXRlckhlaWdodCAtIGhlaWdodCkgLyAyO1xuXG4gICAgb3B0aW9ucy5sZWZ0ID0gbGVmdDtcbiAgICBvcHRpb25zLnRvcCA9IHRvcDtcblxuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhvcHRpb25zKVxuICAgICAgLm1hcChcbiAgICAgICAgKFtrZXksIHZhbHVlXSkgPT5cbiAgICAgICAgICBgJHtlbmNvZGVVUklDb21wb25lbnQoa2V5KX09JHtlbmNvZGVVUklDb21wb25lbnQodmFsdWUpfWBcbiAgICAgIClcbiAgICAgIC5qb2luKCcsJyk7XG4gIH1cblxuICBwcml2YXRlIGNhbkFjY2Vzc1Nlc3Npb25TdG9yYWdlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgbmF2aWdhdG9yLmNvb2tpZUVuYWJsZWQgJiZcbiAgICAgIHR5cGVvZiBTdG9yYWdlICE9PSAndW5kZWZpbmVkJ1xuICAgICk7XG4gIH1cbn1cbiJdfQ==